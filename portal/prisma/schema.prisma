// BLVCKSHELL Workforce Operations Portal - Prisma Schema
// Generated: February 16, 2026
// Database: Supabase Postgres
// Connection: DATABASE_URL (pooled) for runtime, DIRECT_URL for migrations

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum WorkforceAccountType {
  INTERNAL
  VENDOR
}

enum UserRole {
  ADMIN
  VENDOR_OWNER
  VENDOR_WORKER
  INTERNAL_WORKER
}

enum ComplianceDocumentType {
  COI
  WSIB
  AGREEMENT
  HST
  OTHER
}

enum AccessCredentialType {
  KEY
  FOB
  CODE
}

enum AccessCredentialStatus {
  ACTIVE
  LOST
  RETURNED
}

enum JobStatus {
  SCHEDULED
  COMPLETED_PENDING_APPROVAL
  APPROVED_PAYABLE
  PAID
  CANCELLED
}

enum WorkOrderStatus {
  REQUESTED
  APPROVED
  ASSIGNED
  COMPLETED
  INVOICED
  PAID
}

enum IncidentReportType {
  SAFETY
  PROPERTY_DAMAGE
  BIOHAZARD
  LOST_KEY
  OTHER
}

enum SuppliesProvidedBy {
  COMPANY
  CLIENT
  MIXED
}

enum PayoutBatchStatus {
  CALCULATED
  APPROVED
  RELEASED
  PAID
}

enum PayoutLineStatus {
  PENDING
  APPROVED
  RELEASED
  PAID
  VOID
}

enum ChecklistRunStatus {
  InProgress
  Submitted
  Approved
  Rejected
}

enum BillingCadence {
  Monthly
}

enum ContractStatus {
  Active
  Paused
  Ended
}

enum InvoiceStatus {
  Draft
  Sent
  Paid
  Void
}

enum BillingAdjustmentType {
  Charge
  Discount
  Credit
}

enum BillingAdjustmentStatus {
  Proposed
  Approved
  Applied
  Voided
}

enum JobPricingModel {
  IncludedInContract
  Fixed
  Hourly
  PerChecklist
  PerVisit
}

enum BillableStatus {
  Pending
  Approved
  Invoiced
  Void
}

// ============================================================================
// MODELS
// ============================================================================

model ClientOrganization {
  id                  String   @id @default(cuid())
  name                String
  primaryContactName  String
  primaryContactEmail String
  primaryContactPhone String
  notes               String?
  createdAt           DateTime @default(now())

  sites          Site[]
  clientContacts ClientContact[]
  contracts      Contract[]
  invoices       Invoice[]

  @@index([name])
}

model ClientContact {
  id                     String   @id @default(cuid())
  clientOrganizationId   String
  name                   String
  email                  String
  phone                  String?
  role                   String?  // "PM", "AP", "SITE"
  isActive               Boolean  @default(true)
  createdAt              DateTime @default(now())

  clientOrganization     ClientOrganization @relation(fields: [clientOrganizationId], references: [id], onDelete: Restrict)

  @@index([clientOrganizationId])
  @@index([email])
}

model WorkforceAccount {
  id                  String                @id @default(cuid())
  type                WorkforceAccountType
  displayName         String
  legalName           String?
  primaryContactName  String
  primaryContactEmail String
  primaryContactPhone String
  hstNumber           String?
  wsibAccountNumber   String?
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  users               User[]
  workers             Worker[]
  complianceDocuments ComplianceDocument[]
  jobs                Job[]
  workOrders          WorkOrder[]
  siteAssignments     SiteAssignment[]
  payoutLines         PayoutLine[]
  auditLogs           AuditLog[]

  @@index([type])
  @@index([isActive])
}

model User {
  id                 String        @id @default(cuid())
  email              String        @unique
  passwordHash       String
  role               UserRole
  workforceAccountId String?
  name               String
  phone              String?
  isActive           Boolean       @default(true)
  createdAt          DateTime      @default(now())

  workforceAccount   WorkforceAccount? @relation(fields: [workforceAccountId], references: [id], onDelete: SetNull)
  worker             Worker?
  auditLogs          AuditLog[]         @relation("ActorUser")
  approvedJobs       Job[]              @relation("ApprovedJobs")
  invoicesCreated    Invoice[]
  billingAdjustmentsCreated BillingAdjustment[]

  @@index([email])
  @@index([role])
  @@index([workforceAccountId])
  @@index([isActive])
}

model Worker {
  id                 String   @id @default(cuid())
  userId             String   @unique
  workforceAccountId String
  hasPhotoIdOnFile   Boolean  @default(false)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  workforceAccount   WorkforceAccount  @relation(fields: [workforceAccountId], references: [id], onDelete: Restrict)
  jobCompletions     JobCompletion[]
  accessCredentials  AccessCredential[]
  incidentReports    IncidentReport[]
  siteAssignments    SiteAssignment[]
  assignedJobs       Job[]             @relation("AssignedWorker")
  checklistRunItems  ChecklistRunItem[] @relation("CompletedByWorkerRunItem")
  checklistRuns      ChecklistRun[]
  auditLogs          AuditLog[]        @relation("ActorWorker")

  @@index([userId])
  @@index([workforceAccountId])
  @@index([isActive])
}

model ComplianceDocument {
  id                 String                 @id @default(cuid())
  workforceAccountId String
  type               ComplianceDocumentType
  storagePath        String
  expiresAt          DateTime?
  uploadedAt         DateTime               @default(now())

  workforceAccount   WorkforceAccount @relation(fields: [workforceAccountId], references: [id], onDelete: Restrict)

  @@index([workforceAccountId])
  @@index([type])
  @@index([expiresAt])
}

model Site {
  id                    String              @id @default(cuid())
  clientOrganizationId  String
  name                  String
  address               String
  accessInstructions    String?
  serviceWindow         String?
  estimatedDurationMinutes Int?
  requiredPhotoCount    Int                 @default(4)
  suppliesProvidedBy    SuppliesProvidedBy
  doNotEnterUnits       Boolean             @default(true)
  isActive              Boolean             @default(true)

  clientOrganization    ClientOrganization  @relation(fields: [clientOrganizationId], references: [id], onDelete: Restrict)
  accessCredentials     AccessCredential[]
  checklistTemplates    ChecklistTemplate[]
  siteAssignments       SiteAssignment[]
  jobs                  Job[]
  workOrders            WorkOrder[]
  incidentReports       IncidentReport[]
  contracts             Contract[]
  invoiceLineItems      InvoiceLineItem[]
  billingAdjustments    BillingAdjustment[]

  @@index([clientOrganizationId])
  @@index([isActive])
}

// Standing assignment for QR badge: "all locations assigned to this worker/vendor"
// Rule: exactly one of workforceAccountId or workerId is set (enforced by DB CHECK in migration)
model SiteAssignment {
  id                   String   @id @default(cuid())
  siteId               String
  workforceAccountId   String?
  workerId             String?
  roleOnSite           String?  // optional: "PRIMARY", "BACKUP"
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  site                 Site     @relation(fields: [siteId], references: [id], onDelete: Restrict)
  workforceAccount     WorkforceAccount? @relation(fields: [workforceAccountId], references: [id], onDelete: SetNull)
  worker               Worker?  @relation(fields: [workerId], references: [id], onDelete: SetNull)

  @@index([siteId])
  @@index([workforceAccountId])
  @@index([workerId])
  @@index([isActive])
}

model AccessCredential {
  id               String                 @id @default(cuid())
  siteId          String
  type            AccessCredentialType
  identifier      String?  // KEY/FOB: physical id description (e.g. "Key #12")
  identifierHash  String?  // CODE: hashed code only; never store plain code
  identifierHint  String?  // CODE: display hint (e.g. "****1234" or last 2 chars)
  issuedToWorkerId String?
  issuedAt        DateTime               @default(now())
  returnedAt      DateTime?
  status          AccessCredentialStatus  @default(ACTIVE)
  notes           String?

  site            Site    @relation(fields: [siteId], references: [id], onDelete: Restrict)
  issuedToWorker  Worker? @relation(fields: [issuedToWorkerId], references: [id], onDelete: SetNull)

  @@index([siteId])
  @@index([issuedToWorkerId])
  @@index([status])
}

model ChecklistTemplate {
  id           String   @id @default(cuid())
  siteId       String
  checklistId  String?  // e.g., "CL_01", "CL_02" - identifies which template from markdown
  version      Int      @default(1)
  isActive     Boolean  @default(true)
  items        Json     // Array of { itemId, label, required?, photoRequired?, failConditionText? }
  createdAt    DateTime @default(now())

  site         Site           @relation(fields: [siteId], references: [id], onDelete: Restrict)
  checklistRuns ChecklistRun[]

  @@index([siteId])
  @@index([isActive])
  @@index([checklistId])
}

model ChecklistRun {
  id                   String             @id @default(cuid())
  jobId                String
  checklistTemplateId  String
  templateVersion     Int                 // Snapshot of template version at run creation
  status               ChecklistRunStatus  @default(InProgress)
  completedByWorkerId  String
  submittedAt          DateTime?
  approvedAt           DateTime?
  approvedById         String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  job                  Job                 @relation(fields: [jobId], references: [id], onDelete: Restrict)
  checklistTemplate    ChecklistTemplate   @relation(fields: [checklistTemplateId], references: [id], onDelete: Restrict)
  completedByWorker    Worker              @relation(fields: [completedByWorkerId], references: [id], onDelete: Restrict)
  items                ChecklistRunItem[]
  evidence             Evidence[]

  @@index([jobId])
  @@index([checklistTemplateId])
  @@index([completedByWorkerId])
  @@index([status])
}

model ChecklistRunItem {
  id                   String   @id @default(cuid())
  checklistRunId       String
  itemId               String   // e.g. LOB-001
  result               String   // PASS | FAIL | NA
  failReason           String?
  note                 String?
  completedAt          DateTime?
  completedByWorkerId  String?

  checklistRun         ChecklistRun @relation(fields: [checklistRunId], references: [id], onDelete: Cascade)
  completedByWorker   Worker?       @relation("CompletedByWorkerRunItem", fields: [completedByWorkerId], references: [id], onDelete: SetNull)

  @@unique([checklistRunId, itemId])
  @@index([checklistRunId])
}

model Job {
  id                        String    @id @default(cuid())
  siteId                    String
  scheduledStart            DateTime
  scheduledEnd              DateTime?
  status                    JobStatus @default(SCHEDULED)
  payoutAmountCents         Int
  assignedWorkforceAccountId String?
  assignedWorkerId           String?
  isMissed                  Boolean   @default(false)
  missedReason              String?
  makeGoodJobId             String?
  startedAt                 DateTime? // Actual start (disputes / timing truth)
  endedAt                   DateTime?
  actualDurationMinutes     Int?
  checkInMethod             String?   // Optional: "QR" | "GPS" | "MANUAL"
  createdAt                 DateTime  @default(now())
  // Phase 5: billing
  pricingModel              JobPricingModel?  @default(Fixed)
  billableAmountCents       Int?
  billableStatus            BillableStatus?   @default(Pending)
  invoiceId                 String?
  approvedAt                DateTime?
  approvedById              String?

  site                      Site              @relation(fields: [siteId], references: [id], onDelete: Restrict)
  assignedWorkforceAccount  WorkforceAccount? @relation(fields: [assignedWorkforceAccountId], references: [id], onDelete: SetNull)
  assignedWorker            Worker?          @relation("AssignedWorker", fields: [assignedWorkerId], references: [id], onDelete: SetNull)
  makeGoodJob               Job?              @relation("MakeGoodJob", fields: [makeGoodJobId], references: [id], onDelete: SetNull)
  makeGoodJobs              Job[]             @relation("MakeGoodJob")
  completion                JobCompletion?
  checklistRuns             ChecklistRun[]
  invoice                   Invoice?          @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  approvedBy                User?             @relation("ApprovedJobs", fields: [approvedById], references: [id], onDelete: SetNull)

  // Exactly ONE of assignedWorkforceAccountId OR assignedWorkerId must be set (CHECK in migration)
  @@index([siteId])
  @@index([status])
  @@index([assignedWorkforceAccountId])
  @@index([assignedWorkerId])
  @@index([scheduledStart])
  @@index([isMissed])
  @@index([invoiceId])
  @@index([billableStatus])
}

model JobCompletion {
  id               String   @id @default(cuid())
  jobId            String   @unique
  completedByWorkerId String
  completedAt      DateTime @default(now())
  checklistResults Json     // Record<itemId, { result: PASS|FAIL|NA, note? }>
  notes            String?
  isDraft          Boolean  @default(false) // DRAFT status per DECISIONS.md

  job              Job      @relation(fields: [jobId], references: [id], onDelete: Restrict)
  completedByWorker Worker  @relation(fields: [completedByWorkerId], references: [id], onDelete: Restrict)
  evidence         Evidence[]

  @@index([jobId])
  @@index([completedByWorkerId])
  @@index([isDraft])
}

model Evidence {
  id               String   @id @default(cuid())
  jobCompletionId  String
  storagePath      String   // Supabase Storage path: evidence/{jobId}/{completionId}/{timestamp}-{uuid}.{ext}
  fileType         String
  uploadedAt       DateTime @default(now())
  // Phase 2: item-level evidence + redaction metadata
  checklistRunId   String?
  itemId           String?  // e.g. LOB-001 when photo is for a specific checklist item
  redactionApplied Boolean  @default(false)
  redactionType    String?  // face | person | manual
  capturedByUserId String?

  jobCompletion   JobCompletion  @relation(fields: [jobCompletionId], references: [id], onDelete: Cascade)
  checklistRun    ChecklistRun?  @relation(fields: [checklistRunId], references: [id], onDelete: SetNull)

  @@index([jobCompletionId])
  @@index([checklistRunId])
  @@index([itemId])
  @@index([uploadedAt])
}

model WorkOrder {
  id                        String          @id @default(cuid())
  siteId                    String
  requestedBy               String
  description               String
  approvedByAdminId         String?
  priceCents                Int
  status                    WorkOrderStatus @default(REQUESTED)
  beforePhotos              String[]        @default([])
  afterPhotos               String[]        @default([])
  assignedWorkforceAccountId String?
  approvedAt                DateTime?
  completedAt               DateTime?
  invoicedAt                DateTime?

  site                      Site            @relation(fields: [siteId], references: [id], onDelete: Restrict)
  assignedWorkforceAccount  WorkforceAccount? @relation(fields: [assignedWorkforceAccountId], references: [id], onDelete: SetNull)

  @@index([siteId])
  @@index([status])
  @@index([assignedWorkforceAccountId])
}

model IncidentReport {
  id              String             @id @default(cuid())
  siteId          String
  workerId        String
  type            IncidentReportType
  description     String
  photos          String[]           @default([])
  reportedAt      DateTime           @default(now())
  resolvedAt      DateTime?
  resolutionNotes String?

  site            Site               @relation(fields: [siteId], references: [id], onDelete: Restrict)
  worker          Worker             @relation(fields: [workerId], references: [id], onDelete: Restrict)

  @@index([siteId])
  @@index([workerId])
  @@index([type])
  @@index([reportedAt])
}

model PayoutBatch {
  id          String            @id @default(cuid())
  periodStart DateTime
  periodEnd   DateTime
  status      PayoutBatchStatus @default(CALCULATED)
  createdAt   DateTime          @default(now())

  payoutLines PayoutLine[]

  @@index([status])
  @@index([periodStart, periodEnd])
}

model PayoutLine {
  id                 String            @id @default(cuid())
  payoutBatchId      String
  workforceAccountId String
  jobId              String?
  checklistRunId     String?
  description        String?
  siteId             String?
  amountCents        Int
  status             PayoutLineStatus  @default(PENDING)

  payoutBatch       PayoutBatch     @relation(fields: [payoutBatchId], references: [id], onDelete: Restrict)
  workforceAccount  WorkforceAccount @relation(fields: [workforceAccountId], references: [id], onDelete: Restrict)

  @@index([payoutBatchId])
  @@index([workforceAccountId])
  @@index([jobId])
  @@index([checklistRunId])
}

// Phase 5: Billing spine
model Contract {
  id                    String         @id @default(cuid())
  clientOrganizationId  String
  siteId                String
  billingCadence        BillingCadence @default(Monthly)
  monthlyBaseAmountCents Int
  netTermsDays          Int            @default(30)
  effectiveStart        DateTime
  effectiveEnd          DateTime?
  status                ContractStatus @default(Active)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  clientOrganization   ClientOrganization @relation(fields: [clientOrganizationId], references: [id], onDelete: Restrict)
  site                  Site               @relation(fields: [siteId], references: [id], onDelete: Restrict)

  @@index([clientOrganizationId])
  @@index([siteId])
  @@index([status])
}

model Invoice {
  id              String        @id @default(cuid())
  clientId        String        // ClientOrganization id
  invoiceNumber   String        @unique
  periodStart     DateTime
  periodEnd       DateTime
  status          InvoiceStatus @default(Draft)
  issuedAt       DateTime?
  dueAt          DateTime?
  notes           String?
  subtotalCents   Int           @default(0)
  taxCents        Int           @default(0)
  totalCents      Int           @default(0)
  createdById     String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  client          ClientOrganization @relation(fields: [clientId], references: [id], onDelete: Restrict)
  createdBy       User              @relation(fields: [createdById], references: [id], onDelete: Restrict)
  lineItems       InvoiceLineItem[]
  adjustments     BillingAdjustment[]
  jobs            Job[]

  @@index([clientId])
  @@index([status])
  @@index([periodStart, periodEnd])
}

model InvoiceLineItem {
  id               String   @id @default(cuid())
  invoiceId        String
  jobId            String?
  checklistRunId   String?
  contractId       String?
  description      String
  qty              Int      @default(1)
  unitPriceCents   Int
  amountCents      Int
  siteId           String

  invoice          Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  site             Site     @relation(fields: [siteId], references: [id], onDelete: Restrict)

  @@index([invoiceId])
  @@index([jobId])
  @@index([siteId])
}

model BillingAdjustment {
  id               String                 @id @default(cuid())
  invoiceId        String?
  siteId           String?
  jobId            String?
  type             BillingAdjustmentType
  amountCents      Int
  reasonCode       String?
  notes            String?
  createdById      String
  createdAt        DateTime               @default(now())
  status           BillingAdjustmentStatus @default(Proposed)
  evidencePhotoIds String[]               @default([])

  invoice          Invoice?  @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  site             Site?     @relation(fields: [siteId], references: [id], onDelete: SetNull)
  createdBy        User      @relation(fields: [createdById], references: [id], onDelete: Restrict)

  @@index([invoiceId])
  @@index([siteId])
  @@index([jobId])
  @@index([status])
}

model AuditLog {
  id                      String   @id @default(cuid())
  actorUserId             String
  actorWorkerId           String?
  actorWorkforceAccountId String?
  entityType              String   // 'Job' | 'WorkOrder' | 'Invoice' | 'Payout'
  entityId                String
  fromState               String?
  toState                 String?
  metadata                Json?     // Additional context (rejectionReason, overrideReason, etc.)
  createdAt               DateTime  @default(now())

  actorUser               User              @relation("ActorUser", fields: [actorUserId], references: [id], onDelete: Restrict)
  actorWorker              Worker?           @relation("ActorWorker", fields: [actorWorkerId], references: [id], onDelete: SetNull)
  actorWorkforceAccount   WorkforceAccount? @relation(fields: [actorWorkforceAccountId], references: [id], onDelete: SetNull)

  @@index([actorUserId])
  @@index([actorWorkforceAccountId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// Marketing lead capture (same DB; marketing app writes via API or shared client)
model Lead {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  name              String
  phone             String?
  email             String
  buildingAddress   String?
  propertyType      String?
  frequency         String?  // e.g. "3x/week", "daily"
  callbackTime      String?  // e.g. "Morning", "Afternoon", "Either"
  message           String?
  sourcePage        String?
  preferredContact  String?  // email | phone | either
  honeypot          String?  // anti-spam; should be empty
  // Legacy fields (kept for backward compatibility)
  company           String?
  role              String?
  sitesCount        Int?

  @@index([createdAt])
  @@index([email])
}
