generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["partialIndexes"]
}

datasource db {
  provider = "postgresql"
}

model ClientOrganization {
  id                  String          @id @default(cuid())
  name                String
  primaryContactName  String
  primaryContactEmail String
  primaryContactPhone String
  notes               String?
  createdAt           DateTime        @default(now())
  clientContacts      ClientContact[]
  contracts           Contract[]
  invoices            Invoice[]
  portalUsers         User[]
  sites               Site[]

  @@index([name])
}

model ClientContact {
  id                   String             @id @default(cuid())
  clientOrganizationId String
  name                 String
  email                String
  phone                String?
  role                 String?
  isActive             Boolean            @default(true)
  createdAt            DateTime           @default(now())
  clientOrganization   ClientOrganization @relation(fields: [clientOrganizationId], references: [id])

  @@index([clientOrganizationId])
  @@index([email])
}

model WorkforceAccount {
  id                  String               @id @default(cuid())
  type                WorkforceAccountType
  displayName         String
  legalName           String?
  primaryContactName  String
  primaryContactEmail String
  primaryContactPhone String
  hstNumber           String?
  wsibAccountNumber   String?
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  auditLogs           AuditLog[]
  complianceDocuments ComplianceDocument[]
  jobs                Job[]
  payoutLines         PayoutLine[]
  siteAssignments     SiteAssignment[]
  users               User[]
  workOrders          WorkOrder[]
  workers             Worker[]

  @@index([type])
  @@index([isActive])
}

model User {
  id                        String              @id @default(cuid())
  email                     String              @unique
  passwordHash              String
  role                      UserRole
  workforceAccountId        String?
  clientOrganizationId      String?
  name                      String
  phone                     String?
  isActive                  Boolean             @default(true)
  createdAt                 DateTime            @default(now())
  auditLogs                 AuditLog[]          @relation("ActorUser")
  billingAdjustmentsCreated BillingAdjustment[]
  invoicesCreated           Invoice[]
  approvedJobs              Job[]               @relation("ApprovedJobs")
  workforceAccount          WorkforceAccount?   @relation(fields: [workforceAccountId], references: [id])
  clientOrganization        ClientOrganization? @relation(fields: [clientOrganizationId], references: [id])
  worker                    Worker?
  siteTemplatesCreated      SiteTemplate[]      @relation("SiteTemplatesCreated")
  jobTemplatesCreated       JobTemplate[]       @relation("JobTemplatesCreated")
  contractTemplatesCreated   ContractTemplate[]  @relation("ContractTemplatesCreated")
  invoiceTemplatesCreated   InvoiceTemplate[]   @relation("InvoiceTemplatesCreated")
  makeGoodRuleTemplatesCreated MakeGoodRuleTemplate[] @relation("MakeGoodRuleTemplatesCreated")

  @@index([email])
  @@index([role])
  @@index([workforceAccountId])
  @@index([clientOrganizationId])
  @@index([isActive])
}

model Worker {
  id                 String             @id @default(cuid())
  userId             String             @unique
  workforceAccountId String
  hasPhotoIdOnFile   Boolean            @default(false)
  isActive           Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  accessCredentials  AccessCredential[]
  auditLogs          AuditLog[]         @relation("ActorWorker")
  checklistRuns      ChecklistRun[]
  checklistRunItems  ChecklistRunItem[] @relation("CompletedByWorkerRunItem")
  incidentReports    IncidentReport[]
  assignedJobs       Job[]              @relation("AssignedWorker")
  jobCompletions     JobCompletion[]
  siteAssignments    SiteAssignment[]
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  workforceAccount   WorkforceAccount   @relation(fields: [workforceAccountId], references: [id])

  @@index([userId])
  @@index([workforceAccountId])
  @@index([isActive])
}

model ComplianceDocument {
  id                 String                 @id @default(cuid())
  workforceAccountId String
  type               ComplianceDocumentType
  storagePath        String
  expiresAt          DateTime?
  uploadedAt         DateTime               @default(now())
  workforceAccount   WorkforceAccount       @relation(fields: [workforceAccountId], references: [id])

  @@index([workforceAccountId])
  @@index([type])
  @@index([expiresAt])
}

model Site {
  id                       String               @id @default(cuid())
  clientOrganizationId     String
  name                     String
  address                  String
  accessInstructions       String?
  serviceWindow            String?
  estimatedDurationMinutes Int?
  requiredPhotoCount       Int                  @default(4)
  suppliesProvidedBy       SuppliesProvidedBy
  doNotEnterUnits          Boolean              @default(true)
  isActive                 Boolean              @default(true)
  siteTemplateId           String?
  siteTemplateVersion      Int?
  accessCredentials        AccessCredential[]
  billingAdjustments       BillingAdjustment[]
  checklistTemplates       ChecklistTemplate[]
  contracts                Contract[]
  incidentReports          IncidentReport[]
  invoiceLineItems         InvoiceLineItem[]
  jobs                     Job[]
  clientOrganization       ClientOrganization   @relation(fields: [clientOrganizationId], references: [id])
  siteAssignments          SiteAssignment[]
  siteTemplate             SiteTemplate?        @relation(fields: [siteTemplateId], references: [id])
  workOrders               WorkOrder[]

  @@index([clientOrganizationId])
  @@index([isActive])
  @@index([siteTemplateId])
}

model SiteAssignment {
  id                 String            @id @default(cuid())
  siteId             String
  workforceAccountId String?
  workerId           String?
  roleOnSite         String?
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  site               Site              @relation(fields: [siteId], references: [id])
  worker             Worker?           @relation(fields: [workerId], references: [id])
  workforceAccount   WorkforceAccount? @relation(fields: [workforceAccountId], references: [id])

  @@index([siteId])
  @@index([workforceAccountId])
  @@index([workerId])
  @@index([isActive])
}

model AccessCredential {
  id               String                 @id @default(cuid())
  siteId           String
  type             AccessCredentialType
  identifier       String?
  identifierHash   String?
  identifierHint   String?
  issuedToWorkerId String?
  issuedAt         DateTime               @default(now())
  returnedAt       DateTime?
  status           AccessCredentialStatus @default(ACTIVE)
  notes            String?
  issuedToWorker   Worker?                @relation(fields: [issuedToWorkerId], references: [id])
  site             Site                   @relation(fields: [siteId], references: [id])

  @@index([siteId])
  @@index([issuedToWorkerId])
  @@index([status])
}

model ChecklistTemplate {
  id            String         @id @default(cuid())
  siteId        String
  checklistId   String?        // optional logical id for stackable templates (from add_checklist_id_to_template)
  version       Int            @default(1)
  isActive      Boolean        @default(true)
  items         Json
  createdAt     DateTime       @default(now())
  checklistRuns ChecklistRun[]
  site          Site           @relation(fields: [siteId], references: [id])

  @@unique([siteId, version])
  @@index([siteId])
  @@index([isActive])
  @@index([checklistId])
}

model ChecklistRun {
  id                  String             @id @default(cuid())
  jobId               String
  checklistTemplateId String
  templateVersion     Int
  status              ChecklistRunStatus @default(InProgress)
  completedByWorkerId String
  submittedAt         DateTime?
  approvedAt          DateTime?
  approvedById        String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  checklistTemplate   ChecklistTemplate  @relation(fields: [checklistTemplateId], references: [id])
  completedByWorker   Worker             @relation(fields: [completedByWorkerId], references: [id])
  job                 Job                @relation(fields: [jobId], references: [id])
  items               ChecklistRunItem[]
  evidence            Evidence[]

  @@index([jobId])
  @@index([checklistTemplateId])
  @@index([completedByWorkerId])
  @@index([status])
}

// --- Versioned templates (A2): immutable once referenced; instances snapshot templateId + version ---
enum TemplateStatus {
  Draft
  Active
  Archived
}

model SiteTemplate {
  id           String         @id @default(cuid())
  logicalId    String
  version      Int
  status       TemplateStatus @default(Draft)
  body         Json
  createdById  String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  createdBy    User           @relation("SiteTemplatesCreated", fields: [createdById], references: [id])
  sites        Site[]

  @@unique([logicalId, version])
  @@index([logicalId])
  @@index([status])
}

model JobTemplate {
  id           String         @id @default(cuid())
  logicalId    String
  version      Int
  status       TemplateStatus @default(Draft)
  body         Json
  createdById  String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  createdBy    User           @relation("JobTemplatesCreated", fields: [createdById], references: [id])
  jobs         Job[]

  @@unique([logicalId, version])
  @@index([logicalId])
  @@index([status])
}

model ContractTemplate {
  id           String         @id @default(cuid())
  logicalId    String
  version      Int
  status       TemplateStatus @default(Draft)
  body         Json
  createdById  String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  contracts    Contract[]
  createdBy    User           @relation("ContractTemplatesCreated", fields: [createdById], references: [id])

  @@unique([logicalId, version])
  @@index([logicalId])
  @@index([status])
}

model InvoiceTemplate {
  id           String         @id @default(cuid())
  logicalId    String
  version      Int
  status       TemplateStatus @default(Draft)
  body         Json
  createdById  String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  createdBy    User           @relation("InvoiceTemplatesCreated", fields: [createdById], references: [id])
  invoices     Invoice[]

  @@unique([logicalId, version])
  @@index([logicalId])
  @@index([status])
}

model MakeGoodRuleTemplate {
  id           String         @id @default(cuid())
  logicalId    String
  version      Int
  status       TemplateStatus @default(Draft)
  body         Json
  createdById  String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  createdBy    User           @relation("MakeGoodRuleTemplatesCreated", fields: [createdById], references: [id])

  @@unique([logicalId, version])
  @@index([logicalId])
  @@index([status])
}

model ChecklistRunItem {
  id                  String       @id @default(cuid())
  checklistRunId      String
  itemId              String
  result              String
  failReason          String?
  note                String?
  completedAt         DateTime?
  completedByWorkerId String?
  checklistRun        ChecklistRun @relation(fields: [checklistRunId], references: [id], onDelete: Cascade)
  completedByWorker   Worker?      @relation("CompletedByWorkerRunItem", fields: [completedByWorkerId], references: [id])

  @@unique([checklistRunId, itemId])
  @@index([checklistRunId])
}

model Job {
  id                         String            @id @default(cuid())
  siteId                     String
  scheduledStart             DateTime
  scheduledEnd               DateTime?
  status                     JobStatus         @default(SCHEDULED)
  payoutAmountCents          Int
  assignedWorkforceAccountId String?
  assignedWorkerId           String?
  isMissed                   Boolean           @default(false)
  missedReason               String?
  makeGoodJobId              String?
  startedAt                  DateTime?
  endedAt                    DateTime?
  actualDurationMinutes      Int?
  checkInMethod              String?
  createdAt                  DateTime          @default(now())
  pricingModel               JobPricingModel?  @default(Fixed)
  billableAmountCents        Int?
  billableStatus             BillableStatus?   @default(Pending)
  invoiceId                  String?
  approvedAt                 DateTime?
  approvedById               String?
  approvalFlaggedAt          DateTime?
  jobTemplateId              String?
  jobTemplateVersion         Int?
  checklistRuns              ChecklistRun[]
  approvedBy                 User?             @relation("ApprovedJobs", fields: [approvedById], references: [id])
  assignedWorker             Worker?           @relation("AssignedWorker", fields: [assignedWorkerId], references: [id])
  assignedWorkforceAccount   WorkforceAccount? @relation(fields: [assignedWorkforceAccountId], references: [id])
  invoice                    Invoice?          @relation(fields: [invoiceId], references: [id])
  jobTemplate                JobTemplate?      @relation(fields: [jobTemplateId], references: [id])
  makeGoodJob                Job?              @relation("MakeGoodJob", fields: [makeGoodJobId], references: [id])
  makeGoodJobs               Job[]             @relation("MakeGoodJob")
  site                       Site              @relation(fields: [siteId], references: [id])
  completion                 JobCompletion?

  @@index([siteId])
  @@index([status])
  @@index([assignedWorkforceAccountId])
  @@index([assignedWorkerId])
  @@index([scheduledStart])
  @@index([isMissed])
  @@index([invoiceId])
  @@index([billableStatus])
  @@index([jobTemplateId])
}

model JobCompletion {
  id                  String     @id @default(cuid())
  jobId               String     @unique
  completedByWorkerId String
  completedAt         DateTime   @default(now())
  checklistResults    Json
  notes               String?
  isDraft             Boolean    @default(false)
  evidence            Evidence[]
  completedByWorker   Worker     @relation(fields: [completedByWorkerId], references: [id])
  job                 Job        @relation(fields: [jobId], references: [id])

  @@index([jobId])
  @@index([completedByWorkerId])
  @@index([isDraft])
}

model Evidence {
  id               String        @id @default(cuid())
  jobCompletionId  String
  storagePath      String
  fileType         String
  uploadedAt       DateTime      @default(now())
  checklistRunId   String?
  itemId           String?
  redactionApplied Boolean       @default(false)
  redactionType    String?
  capturedByUserId String?
  checklistRun     ChecklistRun? @relation(fields: [checklistRunId], references: [id])
  jobCompletion    JobCompletion @relation(fields: [jobCompletionId], references: [id], onDelete: Cascade)

  @@index([jobCompletionId])
  @@index([checklistRunId])
  @@index([itemId])
  @@index([uploadedAt])
}

model WorkOrder {
  id                         String            @id @default(cuid())
  siteId                     String
  requestedBy                String
  description                String
  approvedByAdminId          String?
  priceCents                 Int
  status                     WorkOrderStatus   @default(REQUESTED)
  beforePhotos               String[]          @default([])
  afterPhotos                String[]          @default([])
  assignedWorkforceAccountId String?
  approvedAt                 DateTime?
  completedAt                DateTime?
  invoicedAt                 DateTime?
  assignedWorkforceAccount   WorkforceAccount? @relation(fields: [assignedWorkforceAccountId], references: [id])
  site                       Site              @relation(fields: [siteId], references: [id])

  @@index([siteId])
  @@index([status])
  @@index([assignedWorkforceAccountId])
}

model IncidentReport {
  id              String             @id @default(cuid())
  siteId          String
  workerId        String
  type            IncidentReportType
  description     String
  photos          String[]           @default([])
  reportedAt      DateTime           @default(now())
  resolvedAt      DateTime?
  resolutionNotes String?
  site            Site               @relation(fields: [siteId], references: [id])
  worker          Worker             @relation(fields: [workerId], references: [id])

  @@index([siteId])
  @@index([workerId])
  @@index([type])
  @@index([reportedAt])
}

model PayoutBatch {
  id          String            @id @default(cuid())
  periodStart DateTime
  periodEnd   DateTime
  status      PayoutBatchStatus @default(CALCULATED)
  createdAt   DateTime          @default(now())
  payoutLines PayoutLine[]

  @@index([status])
  @@index([periodStart, periodEnd])
}

model PayoutLine {
  id                 String           @id @default(cuid())
  payoutBatchId      String
  workforceAccountId String
  jobId              String?
  amountCents        Int
  status             PayoutLineStatus @default(PENDING)
  checklistRunId     String?
  description        String?
  siteId             String?
  payoutBatch        PayoutBatch      @relation(fields: [payoutBatchId], references: [id])
  workforceAccount   WorkforceAccount @relation(fields: [workforceAccountId], references: [id])

  @@index([payoutBatchId])
  @@index([workforceAccountId])
  @@index([jobId])
  @@index([checklistRunId])
}

model Contract {
  id                     String             @id @default(cuid())
  clientOrganizationId   String
  siteId                 String
  billingCadence         BillingCadence     @default(Monthly)
  monthlyBaseAmountCents Int
  netTermsDays           Int                @default(30)
  effectiveStart         DateTime
  effectiveEnd           DateTime?
  status                 ContractStatus     @default(Active)
  contractTemplateId     String?
  contractTemplateVersion Int?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  clientOrganization     ClientOrganization @relation(fields: [clientOrganizationId], references: [id])
  contractTemplate       ContractTemplate?  @relation(fields: [contractTemplateId], references: [id])
  site                   Site               @relation(fields: [siteId], references: [id])

  @@index([clientOrganizationId])
  @@index([siteId])
  @@index([status])
  @@index([contractTemplateId])
}

model Invoice {
  id                  String              @id @default(cuid())
  clientId            String
  invoiceNumber       String              @unique
  periodStart         DateTime
  periodEnd           DateTime
  status              InvoiceStatus       @default(Draft)
  issuedAt            DateTime?
  dueAt               DateTime?
  notes               String?
  subtotalCents       Int                 @default(0)
  taxCents            Int                 @default(0)
  totalCents          Int                 @default(0)
  invoiceTemplateId   String?
  invoiceTemplateVersion Int?
  createdById         String
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  adjustments         BillingAdjustment[]
  client              ClientOrganization  @relation(fields: [clientId], references: [id])
  createdBy           User                @relation(fields: [createdById], references: [id])
  invoiceTemplate     InvoiceTemplate?    @relation(fields: [invoiceTemplateId], references: [id])
  lineItems           InvoiceLineItem[]
  jobs                Job[]

  @@index([clientId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([invoiceTemplateId])
}

model InvoiceLineItem {
  id             String  @id @default(cuid())
  invoiceId      String
  jobId          String?
  checklistRunId String?
  contractId     String?
  description    String
  qty            Int     @default(1)
  unitPriceCents Int
  amountCents    Int
  siteId         String
  invoice        Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  site           Site    @relation(fields: [siteId], references: [id])

  @@index([invoiceId])
  @@index([jobId])
  @@index([siteId])
}

model BillingAdjustment {
  id               String                  @id @default(cuid())
  invoiceId        String?
  siteId           String?
  jobId            String?
  type             BillingAdjustmentType
  amountCents      Int
  reasonCode       String?
  notes            String?
  createdById      String
  createdAt        DateTime                @default(now())
  status           BillingAdjustmentStatus @default(Proposed)
  evidencePhotoIds String[]                @default([])
  createdBy        User                    @relation(fields: [createdById], references: [id])
  invoice          Invoice?                @relation(fields: [invoiceId], references: [id])
  site             Site?                   @relation(fields: [siteId], references: [id])

  @@index([invoiceId])
  @@index([siteId])
  @@index([jobId])
  @@index([status])
}

model AuditLog {
  id                      String            @id @default(cuid())
  actorUserId             String
  actorWorkerId           String?
  actorWorkforceAccountId String?
  entityType              String
  entityId                String
  fromState               String?
  toState                 String?
  metadata                Json?
  createdAt               DateTime          @default(now())
  actorUser               User              @relation("ActorUser", fields: [actorUserId], references: [id])
  actorWorker             Worker?           @relation("ActorWorker", fields: [actorWorkerId], references: [id])
  actorWorkforceAccount   WorkforceAccount? @relation(fields: [actorWorkforceAccountId], references: [id])

  @@index([actorUserId])
  @@index([actorWorkforceAccountId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model Lead {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  name            String
  company         String?
  role            String?
  phone           String?
  email           String
  propertyType    String?
  sitesCount      Int?
  message         String?
  sourcePage      String?
  honeypot        String?
  preferredContact String?
  buildingAddress String?
  frequency       String?
  callbackTime    String?

  @@index([createdAt])
  @@index([email])
}

enum WorkforceAccountType {
  INTERNAL
  VENDOR
}

enum UserRole {
  ADMIN
  CLIENT
  VENDOR_OWNER
  VENDOR_WORKER
  INTERNAL_WORKER
}

enum ComplianceDocumentType {
  COI
  WSIB
  AGREEMENT
  HST
  OTHER
}

enum AccessCredentialType {
  KEY
  FOB
  CODE
}

enum AccessCredentialStatus {
  ACTIVE
  LOST
  RETURNED
}

enum JobStatus {
  SCHEDULED
  COMPLETED_PENDING_APPROVAL
  APPROVED_PAYABLE
  PAID
  CANCELLED
}

enum WorkOrderStatus {
  REQUESTED
  APPROVED
  ASSIGNED
  COMPLETED
  INVOICED
  PAID
}

enum IncidentReportType {
  SAFETY
  PROPERTY_DAMAGE
  BIOHAZARD
  LOST_KEY
  OTHER
}

enum SuppliesProvidedBy {
  COMPANY
  CLIENT
  MIXED
}

enum PayoutBatchStatus {
  CALCULATED
  APPROVED
  RELEASED
  PAID
}

enum PayoutLineStatus {
  PENDING
  APPROVED
  RELEASED
  PAID
  VOID
}

enum ChecklistRunStatus {
  InProgress
  Submitted
  Approved
  Rejected
}

enum BillingCadence {
  Monthly
}

enum ContractStatus {
  Active
  Paused
  Ended
}

enum InvoiceStatus {
  Draft
  Sent
  Paid
  Void
}

enum BillingAdjustmentType {
  Charge
  Discount
  Credit
}

enum BillingAdjustmentStatus {
  Proposed
  Approved
  Applied
  Voided
}

enum JobPricingModel {
  IncludedInContract
  Fixed
  Hourly
  PerChecklist
  PerVisit
}

enum BillableStatus {
  Pending
  Approved
  Invoiced
  Void
}
